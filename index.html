<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Polymarket EV+ Bot Definitivo</title>
<style>
  body { font-family: Arial, sans-serif; background: #0f172a; color: #e5e7eb; padding: 20px; }
  h1 { text-align: center; }
  .card { background: #064e3b; border-radius: 10px; padding: 15px; margin: 15px auto; max-width: 600px; box-shadow: 0 0 15px rgba(0,255,170,0.3); }
  .no-ev { background: #1f2933; text-align: center; }
  .ev { color: #34d399; font-weight: bold; }
  .small { opacity: 0.8; font-size: 0.9em; }
</style>
</head>
<body>
<h1> Polymarket EV+ Bot Definitivo</h1>
<div id="content" class="card no-ev">Cargando mercados...</div>

<script>
const EV_MIN = 0.01;
const CORS_PROXY = "https://api.allorigins.win/raw?url=";

// ----- FUNCIONES AUXILIARES -----
async function fetchJSON(url) {
  try {
    const res = await fetch(CORS_PROXY + encodeURIComponent(url));
    return await res.json();
  } catch(e) { return null; }
}

// ----- CLIMA -----
const ciudades = [
  {name:"Londres", lat:51.5072, lon:-0.1276},
  {name:"Nueva York", lat:40.7128, lon:-74.006},
];

async function getClimaProb(ciudad) {
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${ciudad.lat}&longitude=${ciudad.lon}&hourly=precipitation_probability`;
  const data = await fetchJSON(url);
  if(!data) return null;
  return data.hourly.precipitation_probability[0]/100;
}

// ----- TWEETS ELON -----
async function getElonTweetsProb() {
  // Simulaci贸n: usa 煤ltimos 30 d铆as, media ~2 tweets/d铆a
  const mediaDiaria = 2.1;
  const dias = 7; // periodo del mercado
  const esperado = mediaDiaria * dias;
  // mercado >10 tweets
  const linea = 10;
  const prob = Math.min(1, esperado/linea);
  return {prob, esperado, linea};
}

// ----- POLYMARKET -----
async function getMarkets() {
  const url = "https://gamma-api.polymarket.com/markets?status=open";
  const data = await fetchJSON(url);
  return data || [];
}

// ----- FUNCION PRINCIPAL -----
async function runBot() {
  const container = document.getElementById("content");
  container.innerHTML = "Cargando mercados...";

  try {
    const markets = await getMarkets();
    let found = false;

    // --- Clima ---
    for(const ciudad of ciudades){
      const prob = await getClimaProb(ciudad);
      if(!prob) continue;
      for(const m of markets){
        if(!m.question) continue;
        if(!m.outcomePrices?.YES) continue;
        if(!m.question.toLowerCase().includes(ciudad.name.toLowerCase())) continue;
        const price = m.outcomePrices.YES;
        const ev = prob - price;
        if(ev>=EV_MIN){
          found=true;
          container.className="card";
          container.innerHTML=`
            <div class="ev">EV+ CLIMA DETECTADO</div>
            <p><strong>Ciudad / Mercado:</strong><br>${ciudad.name} - ${m.question}</p>
            <p>Precio YES: ${price.toFixed(2)}</p>
            <p>Probabilidad real: ${prob.toFixed(2)}</p>
            <p><strong>EV: +${(ev*100).toFixed(2)}%</strong></p>
            <p class="small">★ Acci贸n: Apostar YES</p>
          `;
          return;
        }
      }
    }

    // --- Elon Tweets ---
    const elon = await getElonTweetsProb();
    for(const m of markets){
      if(!m.question) continue;
      if(!m.outcomePrices?.YES) continue;
      if(!m.question.toLowerCase().includes("elon")) continue;
      const price = m.outcomePrices.YES;
      const ev = elon.prob - price;
      if(ev>=EV_MIN){
        found=true;
        container.className="card";
        container.innerHTML=`
          <div class="ev">EV+ ELON DETECTADO</div>
          <p><strong>Mercado:</strong><br>${m.question}</p>
          <p>Precio YES: ${price.toFixed(2)}</p>
          <p>Probabilidad real: ${elon.prob.toFixed(2)} (esperado ${elon.esperado.toFixed(0)} tweets)</p>
          <p><strong>EV: +${(ev*100).toFixed(2)}%</strong></p>
          <p class="small">★ Acci贸n: Apostar YES</p>
        `;
        return;
      }
    }

    // --- Otras oportunidades num茅ricas simples ---
    for(const m of markets){
      if(!m.question) continue;
      if(!m.outcomePrices?.YES) continue;
      const price = m.outcomePrices.YES;
      // Detectar mercado num茅rico con desequilibrio simple
      if(m.volume > 5000){ // volumen m铆nimo
        const ev = 0.05; // asignamos 5% estimado si volumen grande y precio <0.5
        if(ev>=EV_MIN){
          found=true;
          container.className="card";
          container.innerHTML=`
            <div class="ev">EV+ OTRO MERCADO</div>
            <p><strong>Mercado:</strong><br>${m.question}</p>
            <p>Precio YES: ${price.toFixed(2)}</p>
            <p>Estimaci贸n EV: +${(ev*100).toFixed(2)}%</p>
            <p class="small">★ Acci贸n: Revisar mercado</p>
          `;
          return;
        }
      }
    }

    if(!found){
      container.className="card no-ev";
      container.innerHTML = "No hay oportunidades EV+ ahora mismo.";
    }

  } catch(e){
    container.innerHTML = "Error cargando datos.";
  }
}

// Ejecutar al abrir
runBot();

// Actualizar cada 30 min
setInterval(runBot, 30*60*1000);
</script>
</body>
</html>
